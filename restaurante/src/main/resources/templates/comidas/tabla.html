<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mi Leña – Gestión de Comidas</title>
    <link rel="icon" th:href="@{/assets/favicon.png}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" th:href="@{/css/custom.css}" />
  </head>
  <body>
    <!-- Loader -->
    <div id="pageLoader" class="page-loader hidden" aria-hidden="true">
      <div class="page-loader-inner">
        <img th:src="@{/assets/Logo1.png}" alt="Mi Leña" class="loader-logo" />
        <div class="loader-text">Cargando…</div>
      </div>
    </div>

    <nav th:replace="~{fragments/navbar :: navbar}"></nav>

    <main class="site-main">
      <section class="py-5 bg-dark bg-pattern text-white">
        <div class="container mt-3">
          <div
            th:if="${success}"
            class="alert alert-success alert-dismissible fade show"
            role="alert"
          >
            <i class="bi bi-check-circle me-2"></i>
            <span th:text="${success}">Plato eliminado...</span>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>

          <div
            th:if="${error}"
            class="alert alert-danger alert-dismissible fade show"
            role="alert"
          >
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:text="${error}">Error</span>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>
        </div>

        <div class="container-xl">
          <!-- Encabezado CON BOTÓN CREAR -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h2 class="text-acento mb-2">
                <i class="bi bi-egg-fried"></i> Gestión de Comidas
              </h2>
              <p class="text-white-75 mb-0">
                Administra el menú del restaurante
              </p>
            </div>
            <a th:href="@{/comidas/nueva}" class="btn btn-success">
              <i class="bi bi-plus-lg"></i> Nueva Comida
            </a>
          </div>

          <!-- Barra de búsqueda -->
          <div class="card bg-dark border-secondary p-3 mb-4">
            <form id="busqueda-form" class="row g-3">
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text bg-dark text-white border-secondary">
                    <i class="bi bi-search"></i>
                  </span>
                  <input
                    type="text"
                    id="searchInput"
                    class="form-control bg-dark text-white border-secondary"
                    placeholder="Buscar por nombre de comida..."
                    autocomplete="off"
                    style="background-color: #212529 !important; color: #fff !important;"
                  />
                </div>
              </div>
              <div class="col-md-3">
                <select id="statusFilter" class="form-select bg-dark text-white border-secondary">
                  <option value="">Todos los estados</option>
                  <option value="activo">Solo activos</option>
                  <option value="inactivo">Solo inactivos</option>
                </select>
              </div>
              <div class="col-md-3">
                <button type="button" id="clearBtn" class="btn btn-outline-secondary w-100">
                  <i class="bi bi-x-circle"></i> Limpiar
                </button>
              </div>
            </form>
          </div>

          <!-- Tabla CON BOTONES CRUD -->
          <div class="card-ml">
            <div class="table-responsive">
              <table class="table table-dark table-striped align-middle mb-0">
                <thead class="table-primario">
                  <tr>
                    <th>Imagen</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Estado</th>
                    <th width="240">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="comida : ${items}">
                    <td>
                      <img
                        th:src="${comida.imagenUrl}"
                        th:alt="${comida.nombre}"
                        class="rounded"
                        style="width: 60px; height: 60px; object-fit: cover"
                      />
                    </td>
                    <td>
                      <div>
                        <h6 class="mb-1" th:text="${comida.nombre}">Nombre</h6>
                        <small
                          class="text-white-50 line-clamp-2"
                          th:text="${comida.descripcion}"
                          >Descripción</small
                        >
                      </div>
                    </td>
                    <td>
                      <span class="fw-bold text-acento"
                        >$<span th:text="${comida.precio}">0</span></span
                      >
                    </td>
                    <td>
                      <span th:if="${comida.activo}" class="badge bg-success"
                        >Activo</span
                      >
                      <span th:unless="${comida.activo}" class="badge bg-danger"
                        >Inactivo</span
                      >
                    </td>
                    <td>
                      <!-- BOTONES CRUD CIRCULARES -->
                      <div class="d-flex gap-1 justify-content-center">
                        <!-- Ver detalles -->
                        <a
                          th:href="@{/comidas/{id}(id=${comida.id})}"
                          class="btn btn-sm btn-outline-info rounded-circle p-2"
                          title="Ver detalles"
                          style="
                            width: 35px;
                            height: 35px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          "
                        >
                          <i class="bi bi-eye"></i>
                        </a>

                        <!-- Editar -->
                        <a
                          th:href="@{/comidas/{id}/editar(id=${comida.id})}"
                          class="btn btn-sm btn-outline-warning rounded-circle p-2"
                          title="Editar"
                          style="
                            width: 35px;
                            height: 35px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          "
                        >
                          <i class="bi bi-pencil"></i>
                        </a>

                        <!-- Gestionar Adicionales -->
                        <a
                          th:href="@{/comidas/{id}/adicionales(id=${comida.id})}"
                          class="btn btn-sm btn-outline-success rounded-circle p-2"
                          title="Gestionar Adicionales"
                          style="
                            width: 35px;
                            height: 35px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                          "
                        >
                          <i class="bi bi-plus-circle"></i>
                        </a>

                        <!-- Eliminar -->
                        <form
                          th:action="@{|/comidas/${comida.id}/eliminar|}"
                          method="post"
                          style="display: inline"
                          th:attr="data-nombre=${comida.nombre}"
                          onsubmit="{
                            const n = this.getAttribute('data-nombre') || 'este plato';
                            return confirm('¿Eliminar la comida ' + n + '?');
                          }"
                        >
                          <button
                            type="submit"
                            class="btn btn-sm btn-outline-danger rounded-circle p-2"
                            title="Eliminar"
                            style="
                              width: 35px;
                              height: 35px;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                            "
                          >
                            <i class="bi bi-trash"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  <tr th:if="${#lists.isEmpty(items)}">
                    <td colspan="5" class="text-center py-4">
                      <div class="text-muted">No se encontraron comidas</div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/main.js}"></script>

    <script>
      function confirmarEliminar(id, nombre) {
        if (confirm('¿Eliminar la comida "' + nombre + '"?')) {
          const form = document.createElement("form");
          form.method = "POST";
          form.action = "/comidas/" + id + "/eliminar";
          document.body.appendChild(form);
          form.submit();
        }
      }

      // Script de búsqueda y filtros
      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const clearBtn = document.getElementById('clearBtn');
        const tableRows = document.querySelectorAll('tbody tr:not([th\\:if])');

        function filterComidas() {
          const searchTerm = searchInput.value.toLowerCase();
          const statusValue = statusFilter.value;
          let visibleRows = 0;

          tableRows.forEach(row => {
            const nombre = row.querySelector('h6')?.textContent.toLowerCase() || '';
            const descripcion = row.querySelector('small')?.textContent.toLowerCase() || '';
            const badgeElement = row.querySelector('.badge');
            const isActive = badgeElement?.textContent.includes('Activo') || false;
            
            const matchesSearch = nombre.includes(searchTerm) || descripcion.includes(searchTerm);
            const matchesStatus = statusValue === '' || 
                                 (statusValue === 'activo' && isActive) || 
                                 (statusValue === 'inactivo' && !isActive);
            
            const shouldShow = matchesSearch && matchesStatus;
            row.style.display = shouldShow ? '' : 'none';
            
            if (shouldShow) visibleRows++;
          });

          // Mostrar/ocultar mensaje de "no encontrados"
          const noResultsRow = document.querySelector('tr[th\\:if*="isEmpty"]');
          if (noResultsRow) {
            noResultsRow.style.display = visibleRows === 0 ? '' : 'none';
          }
        }

        function clearFilters() {
          searchInput.value = '';
          statusFilter.value = '';
          filterComidas();
        }

        searchInput.addEventListener('input', filterComidas);
        statusFilter.addEventListener('change', filterComidas);
        clearBtn.addEventListener('click', clearFilters);
      });
    </script>
  </body>
</html>
